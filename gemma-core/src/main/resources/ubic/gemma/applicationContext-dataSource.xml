<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.springframework.org/schema/beans"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
   http://www.springframework.org/schema/beans/spring-beans-3.2.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

    <util:properties id="dataSourceProps">
        <prop key="rewriteBatchedStatements">true</prop>
        <!-- Default timezone for storage of DATETIME that are mapped to exact moments (i.e. java.util.Date) -->
        <prop key="connectionTimeZone">America/Vancouver</prop>
        <!-- Drops ONLY_FULL_GROUP_BY -->
        <prop key="sessionVariables">sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'</prop>
    </util:properties>

    <beans profile="dev">
        <bean id="tunnel" class="ubic.gemma.persistence.util.LocalSshTunnel">
            <property name="host" value="${gemma.db.tunnel.host}"/>
            <property name="port" value="${gemma.db.tunnel.port}"/>
            <property name="localPort" value="${gemma.db.tunnel.localPort}"/>
            <property name="remoteHost" value="${gemma.db.tunnel.remoteHost}"/>
            <property name="remotePort" value="${gemma.db.tunnel.remotePort}"/>
            <property name="autoStart" value="${gemma.db.tunnel.enabled}"/>
        </bean>
        <bean id="testTunnel" class="ubic.gemma.persistence.util.LocalSshTunnel">
            <property name="host" value="${gemma.testdb.tunnel.host}"/>
            <property name="port" value="${gemma.testdb.tunnel.port}"/>
            <property name="localPort" value="${gemma.testdb.tunnel.localPort}"/>
            <property name="remoteHost" value="${gemma.testdb.tunnel.remoteHost}"/>
            <property name="remotePort" value="${gemma.testdb.tunnel.remotePort}"/>
            <property name="autoStart" value="${gemma.testdb.tunnel.enabled}"/>
        </bean>
    </beans>

    <beans profile="!dev">
        <!-- placeholders to satisfy depends-on -->
        <bean id="tunnel" class="java.lang.Object"/>
        <bean id="testTunnel" class="java.lang.Object"/>
    </beans>

    <!-- we use the same database for production and development -->
    <beans profile="production,dev">
        <!-- Database connection information -->
        <bean id="dataSource" class="com.zaxxer.hikari.HikariDataSource" destroy-method="close" depends-on="tunnel">
            <property name="poolName" value="gemma"/>
            <property name="driverClassName" value="com.mysql.cj.jdbc.Driver"/>
            <property name="username" value="${gemma.db.user}"/>
            <property name="password" value="${gemma.db.password}"/>
            <property name="jdbcUrl" value="${gemma.db.url}"/>
            <property name="dataSourceProperties" ref="dataSourceProps"/>
            <property name="maximumPoolSize" value="${gemma.db.maximumPoolSize}"/>
        </bean>
        <!-- Provide a SecurityContext for running logic with the GROUP_AGENT role -->
        <!-- This is lazily initialized because we only need it for scheduled jobs -->
        <bean id="groupAgentSecurityContext"
              class="ubic.gemma.core.security.ManualAuthenticationServiceBasedSecurityContextFactory"
              lazy-init="true">
            <property name="manualAuthenticationService" ref="manualAuthenticationService"/>
            <property name="userName" value="${gemma.agent.userName}"/>
            <property name="password" value="${gemma.agent.password}"/>
        </bean>
    </beans>

    <beans profile="test,testdb">
        <bean id="dataSource" class="com.zaxxer.hikari.HikariDataSource" destroy-method="close" depends-on="testTunnel">
            <property name="driverClassName" value="com.mysql.cj.jdbc.Driver"/>
            <property name="username" value="${gemma.testdb.user}"/>
            <property name="password" value="${gemma.testdb.password}"/>
            <property name="jdbcUrl" value="${gemma.testdb.url}"/>
            <property name="dataSourceProperties" ref="dataSourceProps"/>
            <property name="maximumPoolSize" value="${gemma.testdb.maximumPoolSize}"/>
        </bean>
        <bean id="groupAgentSecurityContext"
              class="ubic.gemma.core.security.ManualAuthenticationServiceBasedSecurityContextFactory"
              lazy-init="true">
            <property name="manualAuthenticationService" ref="manualAuthenticationService"/>
            <property name="userName" value="${gemma.testdb.agent.userName}"/>
            <property name="password" value="${gemma.testdb.agent.password}"/>
        </bean>
    </beans>

    <beans profile="production">
        <bean id="mailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl">
            <property name="host" value="${mail.host}"/>
            <property name="protocol" value="${mail.protocol}"/>
            <property name="username" value="${mail.username}"/>
            <property name="password" value="${mail.password}"/>
        </bean>
    </beans>

    <beans profile="!production">
        <bean id="mailSender" class="ubic.gemma.core.util.DummyMailSender"/>
    </beans>

</beans>
